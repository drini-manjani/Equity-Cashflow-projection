# Cashflow Projection Model - Detailed Derivations

This document describes, in detail, the model implemented in:

- `msci_projection.ipynb`
- `NAV Logic.ipynb`
- `Structural-cashflows.ipynb`
- `Structural-cashflows-mc.ipynb`

It expands the derivations and shows the exact algebra and estimation logic behind each block.

---

## 0) Overview of the pipeline

The project has three core stages:

1) **MSCI projection** (macro driver)
2) **Omega and NAV start** (valuation return driver)
3) **Structural cashflow simulation** (draws, repayments, recallables, NAV dynamics)

The model is quarterly and uses a discrete-time accounting identity to update NAV and cashflows.

---

## 1) Notation

### 1.1 Indices

- `i` : fund index
- `t` : quarter index (integer)
- `s` : simulation index (MC)

### 1.2 Time and calendar

Let $Q_t$ be the quarter end date (timestamp) at step $t$.

The implementation maps `(Year, Quarter)` to quarter end. In math:

$$
Q_t = \text{QuarterEnd}(\text{Year}, \text{Quarter})
$$

### 1.3 Core cashflow variables

- $\text{Draw}_{i,t}$ : drawdown amount in quarter $t$
- $\text{Rep}_{i,t}$ : repayment (distribution) amount in quarter $t$
- $\text{RC}_{i,t}$ : recallable amount added in $t$
- $\text{NAV}_{i,t}$ : NAV at end of quarter $t$

### 1.4 Capacity and commitment

- $C_i$ : commitment for fund $i$
- $\text{DDCommit}_{i,t}$ : cumulative commitment actually used (drawn from commitment, not recallables)
- $\text{RCAvail}_{i,t}$ : recallable capacity available before drawdown at $t$
- $\text{RemainingCommit}_{i,t}$ : remaining commitment before drawdown
- $\text{Capacity}_{i,t}$ : total capacity before drawdown

In the simulation:

$$
\text{RemainingCommit}_{i,t} = \max(C_i - \text{DDCommit}_{i,t-1}, 0)
$$

$$
\text{Capacity}_{i,t} = \text{RemainingCommit}_{i,t} + \text{RCAvail}_{i,t}
$$

### 1.5 Market and valuation

- $r_t$ : MSCI quarterly return at $t$
- $r_{t-1}$ : lagged MSCI quarterly return
- $\omega_{i,t}$ : valuation return shock for fund $i$ at $t$

### 1.6 Strategy and grade

- $\text{strategy}_i$ : fund strategy bucket (PE, VC, etc.)
- $\text{grade}_{i,t}$ : current grade in {A,B,C,D}
- $\text{age}_{i,t}$ : fund age in quarters (from vintage or first observation)
- $\text{AgeBucket}_{i,t}$ : age bucket (from configured bins)

---

## 2) Data transformations and derived fields

### 2.1 Quarter end

Given year and quarter fields:

$$
\text{quarter\_end} = \text{QuarterEnd}(\text{Year}, \text{Quarter})
$$

### 2.2 Sorting and lagged NAV

For each fund, sort by quarter end and compute:

$$
\text{NAVPrev}_{i,t} = \text{NAV}_{i,t-1}
$$

### 2.3 Event flags and ratios

Define binary events:

$$
\text{draw\_event} = \mathbb{1}[\text{Draw} > 0]
$$

$$
\text{rep\_event} = \mathbb{1}[\text{Rep} > 0]
$$

$$
\text{rc\_given\_rep\_event} = \mathbb{1}[\text{Rep} > 0 \;\wedge\; \text{Recallable} > 0]
$$

Define ratios for lognormal size calibration:

$$
\text{draw\_ratio} = \frac{\text{Draw}}{\text{cap\_proxy}}
$$

$$
\text{rep\_ratio} = \frac{\text{Rep}}{\text{NAVPrev}}
$$

$$
\text{rc\_ratio\_given\_rep} = \frac{\text{Recallable}}{\text{Rep}}
$$

`cap_proxy` is either `Capacity` (if present) or `Commitment_Level`.

### 2.4 Investment period calibration (by strategy)

For each strategy $s$:

- Total drawdown mass by age quarter:

$$
D_s(q) = \sum_{i,t: \text{age}_q=q,\; \text{strategy}=s} \text{Draw}_{i,t}
$$

- Cumulative mass:

$$
\text{Cum}_s(q) = \sum_{u \le q} D_s(u)
$$

- Total mass: $\text{Total}_s = \sum_q D_s(q)$

Choose the smallest age $q$ such that:

$$
\text{Cum}_s(q) \ge \text{IP\_CUM\_PCTL} \cdot \text{Total}_s
$$

This $q$ becomes $\text{IP\_Q}$ for the strategy, clipped to `[IP_Q_MIN, IP_Q_MAX]`.

---

## 3) MSCI projection model (detailed)

### 3.1 Quarterly returns

Let $L_t$ be the MSCI index level at quarter end $t$.

$$
r_t = \frac{L_t}{L_{t-1}} - 1
$$

### 3.2 Regime labeling by quantiles

Compute quantiles on historical returns:

$$
q_{low} = \text{quantile}(r_t,\; low\_q)
$$

$$
q_{high} = \text{quantile}(r_t,\; high\_q)
$$

Assign regimes:

$$
S_t =
\begin{cases}
\text{bear}, & r_t \le q_{low} \\
\text{bull}, & r_t \ge q_{high} \\
\text{flat}, & \text{otherwise}
\end{cases}
$$

### 3.3 Transition matrix with Laplace smoothing

Let $N_{ab}$ be the number of transitions from regime $a$ to $b$. With Laplace smoothing $\lambda$:

$$
N'_{ab} = N_{ab} + \lambda
$$

$$
P_{ab} = \frac{N'_{ab}}{\sum_{b'} N'_{ab'}}
$$

### 3.4 Regime return parameters

For each regime $s$, compute:

$$
\mu_s = \mathbb{E}[r_t \mid S_t=s]
$$

$$
\sigma_s = \sqrt{\text{Var}(r_t \mid S_t=s)}
$$

If a regime has too few observations, the global sigma is used as fallback.

### 3.5 Scenario tilt (bullish/bearish)

To enforce persistence, the transition matrix is tilted. Let `target` be $\text{bull}$ for bullish and $\text{bear}$ for bearish. For each row $a$:

$$
P^{\text{tilt}}_{a,\text{target}} \leftarrow k \cdot P_{a,\text{target}}
$$

$$
P^{\text{tilt}}_{\text{target},\text{target}} \leftarrow k \cdot P_{\text{target},\text{target}}
$$

Then renormalize each row to sum to 1.

### 3.6 Markov simulation

Given a start state $S_0$, simulate:

$$
S_{t+1} \sim \text{Multinomial}(P^{\text{tilt}}_{S_t, :})
$$

### 3.7 Return simulation and index level reconstruction

Given simulated regimes $S_t$:

$$
r_t = \mu_{S_t} + \sigma_{S_t} \varepsilon_t, \quad \varepsilon_t \sim \mathcal{N}(0,1)
$$

Reconstruct index levels:

$$
L_t = L_{t-1}(1 + r_t)
$$

### 3.8 MC mean path (used in later steps)

For $N$ simulated paths, define per-quarter mean return:

$$
\bar{r}_t = \frac{1}{N} \sum_{s=1}^N r_{s,t}
$$

Then construct the mean index path by compounding $\bar{r}_t$.

---

## 4) Omega and NAV logic (detailed)

### 4.1 Accounting identity

Two standard discrete-time identities appear:

**A) Return applies to NAV before flows** (used for historical omega calibration):

$$
\text{NAV}_t = \text{NAV}_{t-1}(1+\omega_t) + \text{Draw}_t - \text{Rep}_t
$$

Solve for $\omega_t$:

$$
\omega_t = \frac{\text{NAV}_t - \text{NAV}_{t-1} - \text{Draw}_t + \text{Rep}_t}{\text{NAV}_{t-1}}
$$

**B) Return applies to NAV after flows** (used in projection step):

$$
\text{NAV}_t = (\text{NAV}_{t-1} + \text{Draw}_t - \text{Rep}_t)(1+\omega_t)
$$

In code, historical omega is derived using form (A). Projection applies omega after flows (form B).

### 4.2 Omega regression on MSCI

For each bucket $b$ (strategy x grade x age bucket), estimate:

$$
\omega_{i,t} = \alpha_b + \beta_{0,b} r_t + \beta_{1,b} r_{t-1} + \sigma_b \varepsilon_{i,t}
$$

The regression is fit with cluster-robust errors by fund. Sparse buckets fall back to larger groupings.

### 4.3 Grade transitions

Let $P_g$ be a grade transition matrix for 1-year steps. If $g_t$ is grade at year $t$:

$$
g_{t+4} \sim \text{Multinomial}(P_g[g_t, :])
$$

Quarterly grades are held constant between year transitions.

### 4.4 NAV start imputation

If NAV is missing at projection start:

- If cumulative drawdowns exist ($\text{DrawCum} > 0$), sample a ratio $R$ from the lognormal fit for $\text{NAV}/\text{DrawCum}$ and set:

$$
\text{NAV}_{\text{start}} = R \cdot \text{DrawCum}
$$

- If no drawdowns exist: $\text{NAV}_{\text{start}} = 0$.

---

## 5) Structural cashflow model (detailed)

### 5.1 State variables per fund

At the start of quarter $t$, we track:

- $\text{NAVPrev}$
- $\text{DDCommit}$ (commitment used)
- $\text{RCAvail}$ (recallable availability)
- grade and age
- $q_{\text{left}}$ (quarters left to cap or lifetime end)

### 5.2 Capacity and commitment

Remaining commitment before drawdown:

$$
\text{RemainingCommit}_{t} = \max(C_i - \text{DDCommit}_{t-1}, 0)
$$

Total capacity:

$$
\text{Capacity}_{t} = \text{RemainingCommit}_{t} + \text{RCAvail}_{t}
$$

### 5.3 Recallable ledger (mechanics)

Recallables are modeled as buckets with creation and expiry quarters.

#### 5.3.1 Recallable cap

$$
\text{RC\_cap} = \rho \cdot C_i
$$

#### 5.3.2 Adding recallables

When a repayment occurs, a recallable amount is sampled:

$$
\text{RC}_{\text{added}} = \text{rc\_ratio} \cdot \text{Rep}_{\text{regular}}
$$

If this breaches the cap, it is reduced to the available room.

#### 5.3.3 Consuming recallables

When a drawdown occurs, recallables are consumed first:

$$
\text{use\_rc} = \min(\text{RCAvail}, \text{Draw})
$$

$$
\text{use\_commit} = \text{Draw} - \text{use\_rc}
$$

$$
\text{DDCommit} \leftarrow \text{DDCommit} + \text{use\_commit}
$$

### 5.4 Investment period and drawdown age shape

Let $\text{IP\_Q}$ be the calibrated investment period (quarters). The drawdown multiplier is:

$$
\text{draw\_mult} = \max(\text{DRAW\_AGE\_MIN\_MULT},\; (1-\text{age}/\text{IP\_Q})^{\text{DRAW\_AGE\_DECAY\_POWER}})
$$

If `ENFORCE_IP_LIMITS` is enabled and $\text{age} > \text{IP\_Q}$, drawdown probability is set to 0 and remaining commitment can be forced at $\text{age}=\text{IP\_Q}$.

### 5.5 Hazard models for event timing

We model event probabilities for drawdown, repayment, and recallable:

- $p_{\text{draw}}$
- $p_{\text{rep}}$
- $p_{\text{rc} \mid \text{rep}}$

#### 5.5.1 Logistic regression

Let $X$ be features and $y$ be event indicators. We fit:

$$
\Pr(y=1 \mid X) = \sigma(X\beta)
$$

where the sigmoid is:

$$
\sigma(z) = \frac{1}{1+e^{-z}}
$$

The IRLS update used in code is:

$$
\beta_{new} = (X^T W X + \lambda I)^{-1} X^T W z
$$

with:

$$
W = \text{diag}(p(1-p)), \quad z = X\beta + \frac{y-p}{p(1-p)}
$$

If hazard fitting fails, we fall back to empirical group means.

#### 5.5.2 Empirical hazard fallback

For any bucket $b$:

$$
p_{\text{draw}}(b) = \mathbb{E}[\text{draw\_event} \mid b]
$$

$$
p_{\text{rep}}(b) = \mathbb{E}[\text{rep\_event} \mid b]
$$

### 5.6 Lognormal size models

For each cashflow size ratio, assume:

$$
\log(\text{ratio}) \sim \mathcal{N}(\mu, \sigma^2)
$$

#### 5.6.1 MLE for lognormal parameters

Given ratios $r_1,\ldots,r_n$:

$$
\hat{\mu} = \frac{1}{n} \sum_{i=1}^n \log r_i
$$

$$
\hat{\sigma}^2 = \frac{1}{n-1} \sum_{i=1}^n (\log r_i - \hat{\mu})^2
$$

#### 5.6.2 Sampling

Given a uniform $u$ from the copula:

$$
z = \Phi^{-1}(u)
$$

$$
\text{ratio} = \exp(\mu + \sigma z)
$$

### 5.7 Copula for dependence

The model uses a one-factor Gaussian copula per quarter:

$$
Z \sim \mathcal{N}(0,1), \quad \varepsilon_i \sim \mathcal{N}(0,1)
$$

$$
X_i = \sqrt{\rho}\,Z + \sqrt{1-\rho}\,\varepsilon_i
$$

$$
u_i = \Phi(X_i)
$$

Separate copulas are used for event and size uniforms, controlled by `RHO_EVENT` and `RHO_SIZE`.

### 5.8 Grade coherence adjustments

Grades adjust both timing and sizes to enforce ordering (A best, D worst):

$$
p_{\text{draw,adj}} = p_{\text{draw}} \cdot m^{\text{draw}}_{\text{grade}}
$$

$$
\text{draw\_ratio}_{\text{adj}} = \text{draw\_ratio} \cdot s^{\text{draw}}_{\text{grade}}
$$

$$
p_{\text{rep,adj}} = p_{\text{rep}} \cdot m^{\text{rep}}_{\text{grade}}
$$

$$
\text{rep\_ratio}_{\text{adj}} = \text{rep\_ratio} \cdot s^{\text{rep}}_{\text{grade}}
$$

### 5.9 MSCI direct effects on repayments

Standardized MSCI return:

$$
\text{msci\_z} = \frac{r_t - \mu_r}{\sigma_r}, \quad \text{msci\_z} \in [-\text{CLIP}, \text{CLIP}]
$$

Hazard boost (logit shift):

$$
\text{logit}(p_{\text{rep,adj}}) \leftarrow \text{logit}(p_{\text{rep,adj}}) + \beta_{\text{MSCI}} \cdot \text{msci\_z}
$$

Size boost:

$$
\text{rep\_ratio} \leftarrow \text{rep\_ratio} \cdot (1 + \gamma_{\text{MSCI}} \cdot \text{msci\_z})
$$

### 5.10 Repayment ramp near end of life

Define tail factor:

$$
\text{tail\_factor} = \max\left(0, \frac{\text{RUNOFF\_Q} - q_{\text{left}}}{\text{RUNOFF\_Q}}\right)
$$

Then:

$$
p_{\text{rep,adj}} = 1 - (1-p_{\text{rep}})^{1 + \text{REP\_RAMP\_P} \cdot \text{runoff\_mult} \cdot \text{tail\_factor}}
$$

$$
\text{rep\_ratio} \leftarrow \text{rep\_ratio} \cdot (1 + \text{REP\_RAMP\_SIZE} \cdot \text{runoff\_mult} \cdot \text{tail\_factor})
$$

### 5.11 Terminal runoff to force NAV toward zero

Define:

$$
\text{available\_nav} = \max(\text{NAVPrev} + \text{Draw} - \text{Rep}_{\text{regular}}, 0)
$$

When $q_{\text{left}} < \text{RUNOFF\_Q}$:

$$
\text{base\_ratio} = \frac{q_{\text{left}}}{q_{\text{left}} + 1}
$$

$$
\text{NAV}_{\text{target}} = \text{available\_nav} \cdot (\text{base\_ratio})^{\text{runoff\_mult}}
$$

$$
\text{Rep}_{\text{terminal}} = \max(0, \text{available\_nav} - \text{NAV}_{\text{target}})
$$

### 5.12 NAV update in projection

$$
\text{NAVAfterFlow} = \max(\text{available\_nav} - \text{Rep}_{\text{terminal}}, 0)
$$

$$
\text{NAV}_{t} = \max(\text{NAVAfterFlow} \cdot (1+\omega_t), 0)
$$

### 5.13 Summary of the per-quarter algorithm

For each fund and quarter:

1) Compute capacity and available recallables.
2) Draw uniforms from the copula (events + sizes).
3) Determine drawdown event and size, update commitment usage.
4) Determine repayment event and size (with grade + MSCI boosts).
5) Add recallables if repayment occurs.
6) Apply terminal runoff if near end.
7) Update NAV using omega.
8) Persist state to next quarter.

---

## 6) Calibration and shrinkage (detailed)

### 6.1 Bucket definitions

Primary bucket:

- strategy x grade x age bucket

Fallback buckets:

- strategy + grade
- strategy + age
- strategy
- global

### 6.2 KS test for lognormal fit

Test lognormality of $\log(\text{ratio})$ using KS.

Let $F_n(x)$ be the empirical CDF of $\log(\text{ratio})$, and $F(x)$ be the fitted Normal CDF. The KS statistic:

$$
D = \max_x |F_n(x) - F(x)|
$$

Critical value (approx):

$$
D_{\text{crit}} = \sqrt{-\frac{1}{2n}\ln(\alpha/2)}
$$

If $D \le D_{\text{crit}}$, the lognormal fit is accepted.

### 6.3 Shrinkage weights

For hazards, a weight is defined as:

$$
w_h(n_{\text{obs}}, n_{\text{funds}}) = \frac{n_{\text{obs}}}{n_{\text{obs}} + N_0} \cdot \frac{n_{\text{funds}}}{n_{\text{funds}} + F_0}
$$

For lognormal sizes, the same formula is used but only if the KS test passes.

### 6.4 Hazard shrinkage (p_draw, p_rep, p_rc)

Let:

- $p_{sg}$ = strategy+grade hazard
- $p_{sa}$ = strategy+age hazard
- $p_s$ = strategy hazard

Weighted parent:

$$
W_{sg} = w_h(n_{sg}, f_{sg}), \quad W_{sa} = w_h(n_{sa}, f_{sa})
$$

$$
T = W_{sg} + W_{sa}
$$

If $T > 0$:

$$
p_{mid} = \frac{W_{sg} p_{sg} + W_{sa} p_{sa}}{T}
$$

$$
p_{parent} = T p_{mid} + (1-T) p_s
$$

Else $p_{parent} = p_s$.

Blend with child:

$$
W_{child} = w_h(n_{child}, f_{child})
$$

$$
p_{final} = W_{child} p_{child} + (1-W_{child}) p_{parent}
$$

### 6.5 Lognormal shrinkage (mu, sigma)

For each ratio type (draw, rep, rc), we do hierarchical shrinkage:

1) strategy with global
2) strategy+grade with strategy
3) strategy+age with strategy
4) combine strategy+grade and strategy+age into a parent
5) blend child with that parent

Generic blend formula:

$$
(\mu, \sigma) = W (\mu_c, \sigma_c) + (1-W)(\mu_p, \sigma_p)
$$

where $W$ is the KS-gated weight.

### 6.6 Runoff calibration by strategy

For each strategy, a runoff multiplier is estimated by comparing tail vs mid repayments.

Let `rep_ratio` be repayment/NAV. Define:

- Tail quarters: last `RUNOFF_Q` quarters before end
- Mid quarters: earlier quarters

Then:

$$
\text{runoff\_mult} = \frac{\mathbb{E}[\text{rep\_ratio}_{\text{tail}}]}{\mathbb{E}[\text{rep\_ratio}_{\text{mid}}]}
$$

Clipped to `[RUNOFF_MULT_MIN, RUNOFF_MULT_MAX]`.

---

## 7) Monte Carlo mode

In MC mode, the entire simulation is repeated `N_SIM` times with different random seeds.

Per simulation $s$, the model produces a full path of cashflows and NAV.

The mean path is:

$$
\bar{X}_{i,t} = \frac{1}{N_{\text{SIM}}} \sum_{s=1}^{N_{\text{SIM}}} X_{i,t}^{(s)}
$$

Event indicators become frequencies in the mean output.

---

## 8) Output fields (key)

- `Draw_Event` : drawdown event indicator (or MC frequency)
- `Draw_Amount` : drawdown size
- `Rep_Event` : repayment event indicator (or MC frequency)
- `Rep_Regular` : repayment amount from lognormal size
- `Rep_Terminal` : terminal runoff repayment
- `Rep_Total` : sum of regular + terminal
- `RC_Event` : recallable event indicator
- `RC_Added` : recallable added
- `NAV_prev`, `NAV_end`
- `Capacity_Pre`, `Remaining_Commit_Pre`, `RC_Avail_Pre`
- `tail_factor` : ramp factor near end of life

---

## 9) Model invariants and checks

The simulation enforces:

- $\text{NAV}_{end} \ge 0$
- $\text{Draw} \le \text{Capacity}_{pre}$
- $\text{RemainingCommit}_{pre} \ge 0$
- Recallables never exceed $\rho \cdot C_i$
- Recallables expire after $E$ quarters
- If projections reach end of life, NAV is amortized toward 0

---

## 10) Quick equation recap

**Omega (calibration)**

$$
\omega_t = \frac{\text{NAV}_t - \text{NAV}_{t-1} - \text{Draw}_t + \text{Rep}_t}{\text{NAV}_{t-1}}
$$

**NAV update (projection)**

$$
\text{NAV}_t = \max\left((\text{NAV}_{t-1} + \text{Draw}_t - \text{Rep}_{regular} - \text{Rep}_{terminal})(1+\omega_t),\; 0\right)
$$

**Drawdown size**

$$
\text{Draw} = \text{Capacity}_{pre} \cdot \exp(\mu_{draw} + \sigma_{draw} z)
$$

**Repayment size**

$$
\text{Rep} = \text{NAVPrev} \cdot \exp(\mu_{rep} + \sigma_{rep} z)
$$

**Recallable size**

$$
\text{RC} = \text{Rep} \cdot \exp(\mu_{rc} + \sigma_{rc} z)
$$

**Terminal runoff**

$$
\text{Rep}_{terminal} = \max\left(0, \text{available\_nav} - \text{available\_nav} \cdot \left(\frac{q_{left}}{q_{left}+1}\right)^{\text{runoff\_mult}}\right)
$$

